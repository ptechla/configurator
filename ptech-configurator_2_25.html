<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Personal Technology — Home Configuration Tool</title>
<link href="https://fonts.googleapis.com/css2?family=Playfair+Display:ital,wght@0,400;0,500;0,600;1,400&family=DM+Mono:wght@300;400;500&family=DM+Sans:wght@300;400;500&display=swap" rel="stylesheet">
<style>
  :root {
    --bg: #F7F5F1;
    --bg-card: #FFFFFF;
    --bg-card-hover: #F0EDE7;
    --ink: #1C1A17;
    --ink-mid: #3D3A35;
    --ink-light: #6B6660;
    --accent: #2C5282;
    --accent-light: #4A7EC7;
    --border: rgba(28,26,23,0.12);
    --border-strong: rgba(28,26,23,0.25);
    --cream: #F7F5F1;
    --slate: #6B6660;
    --white: #FFFFFF;
    --red: #C0392B;
    --green: #2E7D52;
    --gold: #2C5282;
    --gold-light: #4A7EC7;
    --navy: #F7F5F1;
    --navy-mid: #FFFFFF;
    --cream-dark: #EDE9E2;
  }

  * { box-sizing: border-box; margin: 0; padding: 0; }

  body {
    font-family: 'DM Sans', sans-serif;
    background: var(--bg);
    color: var(--ink);
    min-height: 100vh;
    overflow-x: hidden;
  }

  body::before {
    content: '';
    position: fixed;
    inset: 0;
    background: 
      radial-gradient(ellipse at 10% 0%, rgba(44,82,130,0.04) 0%, transparent 50%),
      radial-gradient(ellipse at 90% 100%, rgba(44,82,130,0.03) 0%, transparent 50%);
    pointer-events: none;
    z-index: 0;
  }

  .app {
    position: relative;
    z-index: 1;
    max-width: 1100px;
    margin: 0 auto;
    padding: 0 24px 80px;
  }

  header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 32px 0 48px;
    border-bottom: 1px solid var(--border);
    margin-bottom: 56px;
  }

  .logo-area { display: flex; align-items: center; gap: 20px; }

  .logo-riley {
    height: 36px;
    display: block;
  }

  .logo-slash {
    font-family: 'Playfair Display', serif;
    font-size: 28px;
    font-weight: 300;
    color: var(--ink-light);
    line-height: 1;
    padding: 0 2px;
    user-select: none;
  }

  .logo-ptech-img {
    height: 52px;
    display: block;
    width: auto;
  }

  .header-tag {
    font-family: 'DM Mono', monospace;
    font-size: 11px; letter-spacing: 0.15em;
    color: var(--slate); text-transform: uppercase;
  }

  .progress-container { margin-bottom: 56px; }

  .progress-labels {
    display: flex; justify-content: space-between; margin-bottom: 12px;
  }

  .progress-label { color: var(--slate); }
  .progress-label.active { color: var(--accent); }
  .progress-label.done { color: var(--accent); }
  .progress-label.reachable { color: var(--slate); }
  .progress-label.done, .progress-label.active, .progress-label.reachable { cursor: pointer; touch-action: manipulation; }
  .progress-label.done:hover, .progress-label.reachable:hover { color: var(--ink); text-decoration: underline; text-underline-offset: 3px; }
  .progress-label.active:hover { color: var(--ink-mid); }

  .progress-track {
    height: 2px; background: var(--border);
    position: relative; overflow: hidden;
  }

  .progress-fill {
    height: 100%;
    background: linear-gradient(90deg, var(--accent), var(--accent-light));
    transition: width 0.6s cubic-bezier(0.16, 1, 0.3, 1);
  }

  .step { display: none; }
  .step.active { display: block; animation: stepIn 0.4s cubic-bezier(0.16, 1, 0.3, 1); }

  @keyframes stepIn {
    from { opacity: 0; transform: translateY(20px); }
    to { opacity: 1; transform: translateY(0); }
  }

  .step-header { margin-bottom: 40px; }

  .step-eyebrow {
    font-family: 'DM Mono', monospace;
    font-size: 11px; letter-spacing: 0.18em;
    text-transform: uppercase; color: var(--accent); margin-bottom: 12px;
  }

  .step-title {
    font-family: 'Playfair Display', serif;
    font-size: 42px; font-weight: 400;
    line-height: 1.1; color: var(--ink);
  }

  .step-subtitle {
    font-size: 15px; color: var(--slate);
    margin-top: 12px; font-weight: 300; line-height: 1.6;
  }

  .form-grid {
    display: grid; grid-template-columns: 1fr 1fr;
    gap: 20px; margin-bottom: 32px;
  }

  .form-group { display: flex; flex-direction: column; gap: 8px; }
  .form-group.full { grid-column: 1 / -1; }

  label {
    font-family: 'DM Mono', monospace;
    font-size: 10px; letter-spacing: 0.14em;
    text-transform: uppercase; color: var(--slate);
  }

  input, select {
    background: var(--white);
    border: 1px solid var(--border-strong);
    color: var(--ink); padding: 14px 16px;
    font-family: 'DM Sans', sans-serif;
    font-size: 15px; outline: none;
    transition: border-color 0.2s, background 0.2s;
    width: 100%; -webkit-appearance: none;
  }

  input:focus, select:focus {
    border-color: var(--accent);
    background: rgba(44,82,130,0.03);
  }

  input::placeholder { color: rgba(107,102,96,0.5); }
  select option { background: var(--white); color: var(--ink); }

  /* Category cards */
  .categories-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
    gap: 16px; margin-bottom: 40px;
  }

  .category-card {
    border: 1px solid var(--border);
    padding: 24px; cursor: pointer;
    transition: all 0.3s cubic-bezier(0.16, 1, 0.3, 1);
    position: relative; overflow: hidden;
    background: var(--bg-card);
  }

  .category-card::before {
    content: ''; position: absolute; inset: 0;
    background: linear-gradient(135deg, rgba(44,82,130,0.05), transparent);
    opacity: 0; transition: opacity 0.3s;
  }

  .category-card:hover { border-color: var(--accent); transform: translateY(-2px); box-shadow: 0 4px 20px rgba(28,26,23,0.08); }
  .category-card:hover::before { opacity: 1; }

  .category-card.selected { border-color: var(--accent); background: rgba(44,82,130,0.04); }
  .category-card.selected::before { opacity: 1; }

  .category-card.locked {
    border-color: rgba(44,82,130,0.3);
    background: rgba(44,82,130,0.04);
    cursor: default;
  }
  .category-card.locked::before { opacity: 0.6; }
  .category-card.locked:hover { transform: none; box-shadow: none; }

  .category-icon {
    font-size: 28px;
    margin-bottom: 14px;
    display: block;
    line-height: 1;
    text-align: left;
  }
  .category-icon svg {
    width: 28px;
    height: 28px;
    display: block;
    margin: 0;
    color: var(--ink-mid);
  }

  .category-name {
    font-family: 'Playfair Display', serif;
    font-size: 19px; font-weight: 400;
    margin-bottom: 8px; color: var(--ink);
  }

  .category-desc { font-size: 13px; color: var(--slate); line-height: 1.5; font-weight: 300; }

  .category-check {
    position: absolute; top: 16px; right: 16px;
    width: 20px; height: 20px;
    border: 1px solid var(--border-strong);
    display: flex; align-items: center; justify-content: center;
    font-size: 11px; transition: all 0.2s;
  }

  .category-card.selected .category-check,
  .category-card.locked .category-check {
    background: var(--accent); border-color: var(--accent);
    color: white; font-weight: 700;
  }

  .lock-badge {
    position: absolute; bottom: 14px; right: 16px;
    font-family: 'DM Mono', monospace;
    font-size: 9px; letter-spacing: 0.12em;
    text-transform: uppercase; color: var(--accent);
    opacity: 0.8;
  }

  /* Features */
  .features-section { margin-bottom: 40px; }

  .features-section-title {
    display: flex; align-items: center; gap: 12px;
    font-family: 'Playfair Display', serif;
    font-size: 26px; font-weight: 400;
    margin-bottom: 8px;
    padding-bottom: 16px;
    border-bottom: 1px solid var(--border);
    color: var(--ink);
  }

  /* Universal SVG icon sizing — ensures SVG icons match emoji icon height in all contexts */
  .icon svg,
  .quote-section-header > span:first-child svg,
  .summary-line svg {
    width: 1em;
    height: 1em;
    display: inline-block;
    vertical-align: middle;
    flex-shrink: 0;
  }

  .features-section-title .icon {
    font-size: 22px;
    line-height: 1;
    display: flex;
    align-items: center;
    flex-shrink: 0;
  }
  .features-section-title .icon svg {
    width: 22px;
    height: 22px;
    display: block;
    flex-shrink: 0;
    color: var(--ink-mid);
  }

  .section-locked-note {
    font-family: 'DM Mono', monospace;
    font-size: 10px; letter-spacing: 0.12em;
    text-transform: uppercase; color: var(--accent);
    opacity: 0.75; margin-bottom: 16px;
    margin-top: -8px;
  }

  .feature-items { display: flex; flex-direction: column; gap: 10px; }

  .feature-item {
    display: flex; align-items: center;
    justify-content: space-between;
    padding: 16px 20px;
    border: 1px solid var(--border);
    cursor: pointer; transition: all 0.2s;
    background: var(--bg-card); gap: 16px;
  }

  .feature-item:hover { border-color: var(--accent); background: rgba(44,82,130,0.03); }
  .feature-item.selected { border-color: var(--accent); background: rgba(44,82,130,0.05); }

  .feature-item.locked-item {
    border-color: rgba(44,82,130,0.2);
    background: rgba(44,82,130,0.03);
    cursor: default;
  }
  .feature-item.locked-item:hover { border-color: rgba(44,82,130,0.2); background: rgba(44,82,130,0.03); transform: none; }

  .feature-item-left { display: flex; align-items: center; gap: 14px; flex: 1; }

  .feature-checkbox {
    width: 18px; height: 18px;
    border: 1px solid var(--border-strong);
    display: flex; align-items: center; justify-content: center;
    font-size: 10px; flex-shrink: 0; transition: all 0.2s;
  }

  .feature-item.selected .feature-checkbox,
  .feature-item.locked-item .feature-checkbox {
    background: var(--accent); border-color: var(--accent);
    color: white; font-weight: 700;
  }

  .feature-name { font-size: 14px; font-weight: 400; color: var(--ink); }
  .feature-detail { font-size: 12px; color: var(--slate); margin-top: 2px; font-weight: 300; }

  .feature-price {
    font-family: 'DM Mono', monospace;
    font-size: 13px; color: var(--ink-mid);
    text-align: right; flex-shrink: 0;
  }

  .feature-price-note { font-size: 10px; color: var(--slate); letter-spacing: 0.08em; }

  .qty-input { display: flex; align-items: center; gap: 8px; flex-shrink: 0; }

  .qty-btn {
    width: 26px; height: 26px;
    border: 1px solid var(--border-strong);
    background: var(--white); color: var(--ink);
    cursor: pointer; font-size: 16px;
    display: flex; align-items: center; justify-content: center;
    transition: all 0.2s; line-height: 1;
  }
  .qty-btn:hover { border-color: var(--accent); color: var(--accent); }

  .qty-display {
    font-family: 'DM Mono', monospace;
    font-size: 13px; min-width: 24px;
    text-align: center; color: var(--ink);
  }

  /* Quote */
  .quote-layout {
    display: grid; grid-template-columns: 1fr 360px;
    gap: 32px; align-items: start;
  }

  .quote-sections { display: flex; flex-direction: column; gap: 24px; }

  .quote-section { border: 1px solid var(--border); overflow: hidden; background: var(--bg-card); }

  .quote-section-header {
    display: flex; align-items: center; gap: 10px;
    padding: 14px 20px;
    background: var(--bg);
    border-bottom: 1px solid var(--border);
  }

  .quote-section-title {
    font-family: 'DM Mono', monospace;
    font-size: 11px; letter-spacing: 0.14em;
    text-transform: uppercase; color: var(--slate);
  }

  .quote-item {
    display: flex; justify-content: space-between;
    align-items: center; padding: 12px 20px;
    border-bottom: 1px solid var(--border); gap: 16px;
  }
  .quote-item:last-child { border-bottom: none; }
  .quote-item-name { font-size: 13px; color: var(--ink); }
  .quote-item-detail { font-size: 11px; color: var(--slate); }
  .quote-item-price { font-family: 'DM Mono', monospace; font-size: 13px; color: var(--ink-mid); white-space: nowrap; }

  .summary-card {
    position: sticky; top: 24px;
    border: 1px solid var(--border-strong);
    background: var(--bg-card); padding: 28px;
    box-shadow: 0 4px 24px rgba(28,26,23,0.06);
  }

  .summary-title {
    font-family: 'Playfair Display', serif;
    font-size: 22px; font-weight: 400;
    margin-bottom: 24px; padding-bottom: 16px;
    border-bottom: 1px solid var(--border);
    color: var(--ink);
  }

  .summary-line {
    display: flex; justify-content: space-between;
    align-items: baseline; font-size: 13px;
    color: var(--slate); margin-bottom: 10px;
  }

  .summary-line .val {
    font-family: 'DM Mono', monospace;
    font-size: 12px; color: var(--ink);
  }

  .summary-divider { height: 1px; background: var(--border); margin: 16px 0; }

  .summary-total { display: flex; justify-content: space-between; align-items: baseline; margin-bottom: 8px; }
  .summary-total-label { font-family: 'DM Mono', monospace; font-size: 11px; letter-spacing: 0.12em; text-transform: uppercase; color: var(--slate); }
  .summary-total-value { font-family: 'Playfair Display', serif; font-size: 32px; font-weight: 400; color: var(--ink); }

  .summary-note { font-size: 11px; color: var(--slate); line-height: 1.5; margin-top: 12px; }

  .btn-row {
    display: flex; gap: 16px; margin-top: 40px;
    justify-content: space-between; align-items: center;
  }

  .btn {
    padding: 14px 32px;
    font-family: 'DM Mono', monospace;
    font-size: 12px; letter-spacing: 0.14em;
    text-transform: uppercase; border: none;
    cursor: pointer; transition: all 0.25s;
    display: inline-flex; align-items: center; gap: 8px;
    touch-action: manipulation;
  }

  .selected-chips { display: flex; flex-wrap: wrap; gap: 8px; margin-bottom: 32px; }

  .btn-primary { background: var(--ink); color: white; font-weight: 500; }
  .btn-primary:hover { background: var(--ink-mid); transform: translateY(-1px); box-shadow: 0 8px 24px rgba(28,26,23,0.15); }
  .btn-secondary { background: transparent; color: var(--slate); border: 1px solid var(--border-strong); }
  .btn-secondary:hover { border-color: var(--ink); color: var(--ink); }
  .btn-ghost { background: transparent; color: var(--slate); border: none; padding: 14px 0; }
  .btn-ghost:hover { color: var(--ink); }
  .btn-print { background: var(--bg); color: var(--ink); border: 1px solid var(--border-strong); }
  .btn-print:hover { border-color: var(--ink); }

  .chip {
    font-family: 'DM Mono', monospace;
    font-size: 10px; letter-spacing: 0.1em;
    text-transform: uppercase; padding: 6px 12px;
    border: 1px solid var(--border-strong);
    color: var(--ink-mid); cursor: pointer; transition: all 0.2s;
    background: var(--bg-card);
  }
  .chip:hover { background: var(--bg-card-hover); border-color: var(--accent); color: var(--accent); }
  .chip.active { background: var(--accent); color: white; border-color: var(--accent); }

  .client-meta {
    display: grid; grid-template-columns: 1fr 1fr;
    gap: 12px; margin-bottom: 32px; padding: 24px;
    border: 1px solid var(--border);
    background: var(--bg-card);
  }

  .client-meta-item { display: flex; flex-direction: column; gap: 4px; }
  .client-meta-label { font-family: 'DM Mono', monospace; font-size: 9px; letter-spacing: 0.14em; text-transform: uppercase; color: var(--slate); }
  .client-meta-value { font-size: 14px; color: var(--ink); }
  .quote-date { font-family: 'DM Mono', monospace; font-size: 11px; color: var(--slate); margin-bottom: 32px; }

  /* Music sub-options panel */
  .music-suboptions {
    margin-top: 16px;
    border: 1px solid rgba(44,82,130,0.2);
    background: rgba(44,82,130,0.02);
    overflow: hidden;
    animation: stepIn 0.3s cubic-bezier(0.16, 1, 0.3, 1);
  }

  .music-suboptions-header {
    padding: 12px 20px;
    background: rgba(44,82,130,0.06);
    border-bottom: 1px solid rgba(44,82,130,0.15);
    display: flex;
    align-items: center;
    gap: 10px;
    font-family: 'DM Mono', monospace;
    font-size: 10px;
    letter-spacing: 0.15em;
    text-transform: uppercase;
    color: var(--accent);
  }

  .music-group-label {
    padding: 10px 20px 6px;
    font-family: 'DM Mono', monospace;
    font-size: 9px;
    letter-spacing: 0.18em;
    text-transform: uppercase;
    color: var(--slate);
    border-top: 1px solid var(--border);
    margin-top: 4px;
  }

  .music-group-label:first-child {
    border-top: none;
    margin-top: 0;
    padding-top: 14px;
  }

  .feature-item.sub-option {
    margin: 0 12px 8px;
    background: var(--bg-card);
    border-color: var(--border);
  }

  .feature-item.sub-option:last-child { margin-bottom: 14px; }

  .feature-item.sub-option:hover {
    border-color: var(--accent);
    background: rgba(44,82,130,0.03);
  }

  .feature-item.sub-option.selected {
    border-color: var(--accent);
    background: rgba(44,82,130,0.05);
  }

  /* Dual-qty upgrade row */
  .dual-qty-wrapper {
    display: flex;
    align-items: center;
    gap: 16px;
    flex-shrink: 0;
  }

  .dual-qty-block {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 4px;
  }

  .dual-qty-label {
    font-family: 'DM Mono', monospace;
    font-size: 9px;
    letter-spacing: 0.12em;
    text-transform: uppercase;
    color: var(--slate);
    white-space: nowrap;
  }

  .dual-qty-price {
    font-family: 'DM Mono', monospace;
    font-size: 11px;
    color: var(--ink-mid);
    white-space: nowrap;
  }

  .upgrade-total {
    font-family: 'DM Mono', monospace;
    font-size: 13px;
    color: var(--ink-mid);
    text-align: right;
    min-width: 70px;
    flex-shrink: 0;
  }

  .upgrade-total-note {
    font-size: 10px;
    color: var(--slate);
    letter-spacing: 0.06em;
  }

  /* Section notes */
  .section-notes-wrapper {
    margin-top: 16px;
    border: 1px solid var(--border);
    background: var(--bg-card);
    overflow: hidden;
  }

  .section-notes-label {
    display: flex;
    align-items: center;
    gap: 8px;
    padding: 10px 16px;
    font-family: 'DM Mono', monospace;
    font-size: 10px;
    letter-spacing: 0.14em;
    text-transform: uppercase;
    color: var(--slate);
    border-bottom: 1px solid var(--border);
    background: var(--bg);
  }

  .section-notes-label span { opacity: 0.6; font-size: 14px; }

  .section-notes-textarea {
    width: 100%;
    background: transparent;
    border: none;
    color: var(--ink);
    font-family: 'DM Sans', sans-serif;
    font-size: 13px;
    font-weight: 300;
    line-height: 1.6;
    padding: 14px 16px;
    resize: vertical;
    min-height: 80px;
    outline: none;
    transition: background 0.2s;
  }

  .section-notes-textarea:focus {
    background: rgba(44,82,130,0.02);
  }

  .section-notes-textarea::placeholder {
    color: rgba(107,102,96,0.4);
    font-style: italic;
  }

  .toast {
    position: fixed; bottom: 32px; right: 32px;
    background: var(--ink); color: white;
    padding: 14px 24px;
    font-family: 'DM Mono', monospace;
    font-size: 12px; letter-spacing: 0.1em; font-weight: 500;
    transform: translateY(80px); opacity: 0;
    transition: all 0.4s cubic-bezier(0.16, 1, 0.3, 1);
    z-index: 100;
  }
  .toast.show { transform: translateY(0); opacity: 1; }

  @media print {
    body { background: white; color: #111; }
    body::before { display: none; }
    .btn-row, header, .progress-container { display: none; }
    .summary-card { position: static; border: 1px solid #ccc; background: #f9f6ef; }
    .quote-layout { grid-template-columns: 1fr; }
    .quote-section { border: 1px solid #ddd; }
    .step { display: block !important; }
    .step:not(#step-quote) { display: none !important; }
  }
  /* ── Next Steps ──────────────────────────────────────────── */

  .ns-stack {
    display: flex;
    flex-direction: column;
    gap: 0;
    margin-bottom: 48px;
  }

  .ns-section {
    border: 1px solid var(--border);
    background: var(--bg-card);
    margin-bottom: 12px;
    transition: all 0.4s cubic-bezier(0.16, 1, 0.3, 1);
    overflow: hidden;
    position: relative;
  }

  .ns-section.locked {
    opacity: 0.38;
    pointer-events: none;
  }

  .ns-section.active {
    opacity: 1;
    pointer-events: auto;
    border-color: var(--border-strong);
    box-shadow: 0 2px 16px rgba(28,26,23,0.06);
  }

  .ns-section.done {
    opacity: 1;
    pointer-events: auto;
    border-color: var(--accent);
  }

  .ns-section.done::after {
    content: '';
    position: absolute;
    top: 0; left: 0;
    width: 3px; height: 100%;
    background: var(--accent);
  }

  .ns-section-inner {
    display: grid;
    grid-template-columns: 48px 1fr auto;
    gap: 28px;
    padding: 28px 32px;
    align-items: start;
  }

  .ns-number {
    font-family: 'Playfair Display', serif;
    font-size: 32px;
    font-weight: 400;
    color: var(--border-strong);
    line-height: 1;
    padding-top: 2px;
    transition: color 0.3s;
  }

  .ns-section.active .ns-number { color: var(--accent-light); }
  .ns-section.done .ns-number { color: var(--accent); }

  .ns-label {
    font-family: 'Playfair Display', serif;
    font-size: 22px;
    font-weight: 400;
    color: var(--ink);
    margin-bottom: 12px;
    line-height: 1.2;
  }

  .ns-body {
    font-size: 14px;
    color: var(--ink-mid);
    line-height: 1.7;
    font-weight: 300;
    max-width: 640px;
  }

  .ns-total-display {
    font-family: 'Playfair Display', serif;
    font-size: 48px;
    font-weight: 400;
    color: var(--ink);
    margin-bottom: 16px;
    line-height: 1;
    letter-spacing: -0.01em;
  }

  .ns-fee-block {
    margin-top: 20px;
    padding: 16px 20px;
    border: 1px solid var(--border);
    background: var(--bg);
  }

  .ns-fee-row {
    display: flex;
    justify-content: space-between;
    align-items: baseline;
    gap: 16px;
  }

  .ns-fee-label {
    font-family: 'DM Mono', monospace;
    font-size: 10px;
    letter-spacing: 0.14em;
    text-transform: uppercase;
    color: var(--slate);
  }

  .ns-fee-value {
    font-family: 'Playfair Display', serif;
    font-size: 28px;
    font-weight: 400;
    color: var(--ink);
  }

  .ns-fee-note {
    font-size: 11px;
    color: var(--slate);
    margin-top: 4px;
    font-weight: 300;
  }

  .ns-payments {
    margin-top: 20px;
    border: 1px solid var(--border);
    background: var(--bg);
    overflow: hidden;
  }

  .ns-payment-row {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 12px 20px;
    border-bottom: 1px solid var(--border);
    gap: 16px;
  }

  .ns-payment-row:last-child { border-bottom: none; }

  .ns-payment-row.total-row {
    background: var(--bg-card);
    border-top: 1px solid var(--border-strong);
  }

  .ns-payment-row.total-row .ns-payment-label {
    font-weight: 500;
    color: var(--ink);
  }

  .ns-payment-row.total-row .ns-payment-amt {
    font-size: 15px;
    color: var(--ink);
  }

  .ns-payment-label {
    font-size: 13px;
    color: var(--ink);
    font-weight: 400;
  }

  .ns-payment-pct {
    font-size: 11px;
    color: var(--slate);
    margin-top: 2px;
    font-weight: 300;
  }

  .ns-payment-amt {
    font-family: 'DM Mono', monospace;
    font-size: 13px;
    color: var(--ink-mid);
    white-space: nowrap;
    flex-shrink: 0;
  }

  .ns-check-btn {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 8px;
    background: none;
    border: none;
    cursor: pointer;
    padding: 4px 0;
    min-width: 80px;
    transition: opacity 0.2s;
    flex-shrink: 0;
  }

  .ns-check-btn:hover:not(:disabled) .ns-check-box { border-color: var(--accent); }
  .ns-check-btn:disabled { cursor: default; }

  .ns-check-box {
    width: 32px;
    height: 32px;
    border: 1.5px solid var(--border-strong);
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.25s cubic-bezier(0.16, 1, 0.3, 1);
    position: relative;
    flex-shrink: 0;
  }

  .ns-check-box.checked {
    background: var(--accent);
    border-color: var(--accent);
  }

  .ns-check-box.checked::after {
    content: '';
    width: 14px;
    height: 8px;
    border-left: 2px solid white;
    border-bottom: 2px solid white;
    transform: rotate(-45deg) translateY(-2px);
    display: block;
  }

  .ns-check-label {
    font-family: 'DM Mono', monospace;
    font-size: 9px;
    letter-spacing: 0.12em;
    text-transform: uppercase;
    color: var(--slate);
    text-align: center;
    line-height: 1.4;
  }

  .ns-section.done .ns-check-label { color: var(--accent); }

  .ns-accept-row {
    display: flex;
    flex-direction: column;
    align-items: flex-start;
    gap: 12px;
    padding: 32px 0 0;
    border-top: 1px solid var(--border);
    margin-top: 8px;
  }

  .ns-accept-btn {
    padding: 18px 48px;
    font-size: 13px;
    letter-spacing: 0.18em;
    transition: all 0.3s cubic-bezier(0.16, 1, 0.3, 1);
  }

  .ns-accept-btn:disabled {
    opacity: 0.35;
    cursor: default;
    transform: none !important;
    box-shadow: none !important;
  }

  .ns-accept-btn:not(:disabled) {
    background: var(--accent);
  }

  .ns-accept-btn:not(:disabled):hover {
    background: #1a3a6b;
    transform: translateY(-2px);
    box-shadow: 0 8px 28px rgba(44,82,130,0.25);
  }

  .ns-accept-note {
    font-size: 12px;
    color: var(--slate);
    font-weight: 300;
  }

  @keyframes nsUnlock {
    from { opacity: 0.38; transform: translateY(6px); }
    to { opacity: 1; transform: translateY(0); }
  }

  .ns-section.unlocking {
    animation: nsUnlock 0.45s cubic-bezier(0.16, 1, 0.3, 1) forwards;
  }

</style>
</head>
<body>
<div class="app">

<header>
    <div class="logo-area">
      <img class="logo-riley" src="data:image/webp;base64,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" alt="Riley">
      <span class="logo-slash">/</span>
      <img class="logo-ptech-img" src="data:image/png;base64,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" alt="Personal Technology">
    </div>
    <div class="header-tag">Home Configuration Tool</div>
  </header>

  <div class="progress-container">
    <div class="progress-labels">
      <span class="progress-label" id="pl-0" onclick="plClick(0)">Client Info</span>
      <span class="progress-label" id="pl-1" onclick="plClick(1)">Categories</span>
      <span class="progress-label" id="pl-2" onclick="plClick(2)">Features</span>
      <span class="progress-label" id="pl-3" onclick="plClick(3)">Reveiw</span>
    </div>
    <div class="progress-track"><div class="progress-fill" id="progress-fill"></div></div>
  </div>

  <!-- STEP 0: Client Info -->
  <div class="step active" id="step-0">
    <div class="step-header">
      <div class="step-eyebrow">Step 01 of 04</div>
      <h1 class="step-title">Tell us about<br>the project.</h1>
      <p class="step-subtitle">We'll use this to personalize your proposal.</p>
    </div>

    <div class="form-grid">
      <div class="form-group">
        <label>Client First Name</label>
        <input type="text" id="client-first" placeholder="e.g. Michael">
      </div>
      <div class="form-group">
        <label>Client Last Name</label>
        <input type="text" id="client-last" placeholder="e.g. Thornton">
      </div>
      <div class="form-group">
        <label>Email Address</label>
        <input type="email" id="client-email" placeholder="email@example.com">
      </div>
      <div class="form-group">
        <label>Phone Number</label>
        <input type="tel" id="client-phone" placeholder="(xxx) xxx-xxxx">
      </div>
      <div class="form-group full">
        <label>Property Address</label>
        <input type="text" id="client-address" placeholder="123 Oak Drive, Pasadena, CA 91103">
      </div>
      <div class="form-group full">
        <label>Estimated Square Footage</label>
        <input type="number" id="sq-footage" value="2400" min="100">
      </div>
    </div>

    <div class="btn-row">
      <span></span>
      <button class="btn btn-primary" onclick="goTo(1)">Continue →</button>
    </div>
  </div>

  <!-- STEP 1: Categories -->
  <div class="step" id="step-1">
    <div class="step-header">
      <div class="step-eyebrow">Step 02 of 04</div>
      <h1 class="step-title">Which systems<br>are included?</h1>
      <p class="step-subtitle">Select all categories for this project. Locked items are standard in every configuration.</p>
    </div>

    <div class="categories-grid" id="categories-grid"></div>

    <div class="btn-row">
      <button class="btn btn-ghost" onclick="goTo(0)">← Back</button>
      <button class="btn btn-primary" onclick="goToFeatures()">Configure Features →</button>
    </div>
  </div>

  <!-- STEP 2: Features -->
  <div class="step" id="step-2">
    <div class="step-header">
      <div class="step-eyebrow">Step 03 of 04</div>
      <h1 class="step-title">Select your<br>features.</h1>
      <p class="step-subtitle">Check all applicable items. Quantities can be adjusted where shown.</p>
    </div>

    <div class="selected-chips" id="category-chips"></div>
    <div id="features-container"></div>

    <div class="btn-row">
      <button class="btn btn-ghost" onclick="goTo(1)">← Back</button>
      <button class="btn btn-primary" onclick="goTo(3)">Review Estimate →</button>
    </div>
  </div>

  <!-- STEP 3: Quote -->
  <div class="step" id="step-quote">
    <div class="step-header">
      <div class="step-eyebrow">Step 04 of 04</div>
      <h1 class="step-title">Review<br>Estimate.</h1>
      <p class="step-subtitle">Review the itemized estimate below. Print or save as PDF to share with your client.</p>
    </div>

    <div class="quote-layout">
      <div>
        <div class="quote-date" id="quote-date"></div>
        <div class="client-meta" id="quote-client-meta"></div>
        <div class="quote-sections" id="quote-sections"></div>
      </div>

      <div class="summary-card">
        <div class="summary-title">Estimate Summary</div>
        <div id="summary-lines"></div>
        <div class="summary-divider"></div>
        <div class="summary-total">
          <div class="summary-total-label">Est. Total</div>
          <div class="summary-total-value" id="grand-total">$0</div>
        </div>
        <div class="summary-note">Estimate only. Final pricing subject to site assessment and signed proposal. Prices include estimated sales tax.</div>
        <div style="margin-top:24px; display:flex; flex-direction:column; gap:10px;">
          <button class="btn btn-primary" onclick="window.print()">🖨 Print / Save PDF</button>
          <button class="btn btn-print" onclick="goToNextSteps()">Next Steps →</button>
        </div>
      </div>
    </div>

    <div class="btn-row">
      <button class="btn btn-ghost" onclick="goTo(2)">← Edit Features</button>
      <button class="btn btn-secondary" onclick="resetTool()">Start New Project</button>
    </div>
  </div>

  <!-- STEP 5: Next Steps -->
  <div class="step" id="step-next">
    <div class="step-header">
      <div class="step-eyebrow">Step 05 of 05</div>
      <h1 class="step-title">Next<br>Steps.</h1>
      <p class="step-subtitle">Review and acknowledge each section to proceed. All four items must be confirmed before submitting.</p>
    </div>

    <div class="ns-stack" id="ns-stack">

      <!-- Section 1: Approve Estimate -->
      <div class="ns-section active" id="ns-1">
        <div class="ns-section-inner">
          <div class="ns-number">01</div>
          <div class="ns-content">
            <div class="ns-label">Estimated Total</div>
            <div class="ns-total-display" id="ns-total-display">$0</div>
            <p class="ns-body">I have reviewed the itemized estimate above and approve the projected total as the budget for this project.</p>
          </div>
          <button class="ns-check-btn" id="ns-cb-1" onclick="nsCheck(1)">
            <span class="ns-check-box" id="ns-box-1"></span>
            <span class="ns-check-label" id="ns-clabel-1">Approve Estimate</span>
          </button>
        </div>
      </div>

      <!-- Section 2: Design Contract -->
      <div class="ns-section locked" id="ns-2">
        <div class="ns-section-inner">
          <div class="ns-number">02</div>
          <div class="ns-content">
            <div class="ns-label">Design Contract</div>
            <p class="ns-body">Personal Technology will design and engineer your home technology systems within the approved budget. The design process covers full system architecture, equipment selection, and drawings — everything required to build and install your system precisely as configured.</p>
            <div class="ns-fee-block" id="ns-fee-block">
              <div class="ns-fee-row">
                <span class="ns-fee-label">Design &amp; Engineering Fee</span>
                <span class="ns-fee-value" id="ns-design-fee">—</span>
              </div>
              <div class="ns-fee-note">3% of Estimated Total</div>
            </div>
          </div>
          <button class="ns-check-btn" id="ns-cb-2" onclick="nsCheck(2)" disabled>
            <span class="ns-check-box" id="ns-box-2"></span>
            <span class="ns-check-label" id="ns-clabel-2">Accept Design Contract</span>
          </button>
        </div>
      </div>

      <!-- Section 3: Contract Documents & Payments -->
      <div class="ns-section locked" id="ns-3">
        <div class="ns-section-inner">
          <div class="ns-number">03</div>
          <div class="ns-content">
            <div class="ns-label">Contract Documents &amp; Schedule of Payments</div>
            <p class="ns-body">Following the design phase, Personal Technology will deliver the full contract documents including system drawings, equipment schedules, and a binding proposal. Payment is structured across the following project milestones:</p>

            <div class="ns-payments" id="ns-payments">
              <div class="ns-payment-row">
                <div>
                  <div class="ns-payment-label">Design Contract Fee</div>
                  <div class="ns-payment-pct">3% of Estimated Total</div>
                </div>
                <div class="ns-payment-amt" id="ns-pay-design">—</div>
              </div>
              <div class="ns-payment-row">
                <div>
                  <div class="ns-payment-label">Proposal Acceptance</div>
                  <div class="ns-payment-pct">27% of remaining balance</div>
                </div>
                <div class="ns-payment-amt" id="ns-pay-1">—</div>
              </div>
              <div class="ns-payment-row">
                <div>
                  <div class="ns-payment-label">Completion of Rough-In</div>
                  <div class="ns-payment-pct">40% of remaining balance</div>
                </div>
                <div class="ns-payment-amt" id="ns-pay-2">—</div>
              </div>
              <div class="ns-payment-row">
                <div>
                  <div class="ns-payment-label">Scheduling of Trim</div>
                  <div class="ns-payment-pct">20% of remaining balance</div>
                </div>
                <div class="ns-payment-amt" id="ns-pay-3">—</div>
              </div>
              <div class="ns-payment-row">
                <div>
                  <div class="ns-payment-label">Day 1</div>
                  <div class="ns-payment-pct">10% of remaining balance</div>
                </div>
                <div class="ns-payment-amt" id="ns-pay-4">—</div>
              </div>
              <div class="ns-payment-row total-row">
                <div>
                  <div class="ns-payment-label">Estimated Total</div>
                </div>
                <div class="ns-payment-amt" id="ns-pay-total">—</div>
              </div>
            </div>
          </div>
          <button class="ns-check-btn" id="ns-cb-3" onclick="nsCheck(3)" disabled>
            <span class="ns-check-box" id="ns-box-3"></span>
            <span class="ns-check-label" id="ns-clabel-3">Acknowledge Payment Schedule</span>
          </button>
        </div>
      </div>

      <!-- Section 4: Production -->
      <div class="ns-section locked" id="ns-4">
        <div class="ns-section-inner">
          <div class="ns-number">04</div>
          <div class="ns-content">
            <div class="ns-label">Production &amp; Installation</div>
            <p class="ns-body">With the contract documents signed and the deposit received, your project enters production. Equipment is procured, programmed, and staged — then installation follows the construction schedule for the home. Personal Technology coordinates directly with your general contractor to ensure all rough-in, trim, and commissioning phases align with the build timeline.</p>
          </div>
          <button class="ns-check-btn" id="ns-cb-4" onclick="nsCheck(4)" disabled>
            <span class="ns-check-box" id="ns-box-4"></span>
            <span class="ns-check-label" id="ns-clabel-4">Ready to Proceed</span>
          </button>
        </div>
      </div>

    </div><!-- /ns-stack -->

    <div class="ns-accept-row" id="ns-accept-row">
      <button class="btn btn-primary ns-accept-btn" id="ns-accept-btn" onclick="nsAccept()" disabled>
        Accept
      </button>
      <p class="ns-accept-note" id="ns-accept-note">Confirm all four sections above to enable submission.</p>
    </div>

    <div class="btn-row">
      <button class="btn btn-ghost" onclick="goTo(3)">← Back to Review</button>
    </div>
  </div>

</div>

<div class="toast" id="toast"></div>

<script>
// ─────────────────────────────────────────────────────────────
// PRICE HELPERS
// ─────────────────────────────────────────────────────────────
function getSqft() {
  return parseInt(document.getElementById('sq-footage').value) || 2400;
}

function calcNetworkPrice() {
  const sqft = getSqft();
  const base = 14500;
  if (sqft <= 2400) return base;
  const overage = sqft - 2400;
  const units = Math.ceil(overage / 800);
  return base + (units * 1500);
}

function calcLightingPrice() {
  return 8 * getSqft();
}

function calcTunableLightingPrice() {
  return 17 * getSqft();
}

// Additional rooms pricing:
// Rooms that land on position 1, 5, 9, 13... (index % 4 === 0) → $5,950
// All other rooms → $2,215
function calcExtraRoomsPrice(qty) {
  let total = 0;
  for (let i = 0; i < qty; i++) {
    total += (i % 4 === 0) ? 5950 : 2215;
  }
  return total;
}

function countSelectedTVs() {
  const tvIds = ['tv55', 'tv65', 'tv75', 'tv85'];
  return tvIds.reduce((sum, id) => {
    if (state.selectedFeatures[id]) {
      return sum + (state.selectedFeatures[id].qty || 1);
    }
    return sum;
  }, 0);
}

function calcDistributedVideoPrice() {
  return 14000 + (2400 * countSelectedTVs());
}

// Upgrade pricing: total cost for N pairs
// upgradePrice = [totalFor1pair, totalFor2pairs]
// Beyond 2: each additional pair costs (p2 - p1)
function calcUpgradePrice(upgradePrice, qty) {
  if (qty <= 0) return 0;
  if (qty === 1) return upgradePrice[0];
  if (qty === 2) return upgradePrice[1];
  const increment = upgradePrice[1] - upgradePrice[0];
  return upgradePrice[1] + (qty - 2) * increment;
}

// ─────────────────────────────────────────────────────────────
// CATEGORIES
// locked: cannot be deselected, always in quote
// alwaysSelected (feature level): always checked, no toggle
// dynamicPrice: function() → price (recalculated at render)
// ─────────────────────────────────────────────────────────────
const CATEGORIES = [
  {
    id: 'base',
    icon: '⚙️',
    name: 'Base Configuration',
    desc: 'Wire termination infrastructure, equipment housing, power quality and distribution.',
    locked: true,
    features: [
      {
        id: 'base1',
        name: 'Base Infrastructure',
        detail: 'Wire termination infrastructure, equipment housing, power quality and distribution.',
        price: 23500,
        unit: 'system',
        alwaysSelected: true,
        hasQty: false
      }
    ]
  },
  {
    id: 'network',
    icon: '<svg viewBox="0 0 24 24" width="1em" height="1em" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M5 12.55a11 11 0 0 1 14.08 0"/><path d="M1.42 9a16 16 0 0 1 21.16 0"/><path d="M8.53 16.11a6 6 0 0 1 6.95 0"/><circle cx="12" cy="20" r="1" fill="currentColor"/></svg>',
    name: 'Networking and WiFi',
    desc: 'Enterprise-grade WiFi, cabling and managed switching.',
    locked: true,
    features: [
      {
        id: 'net1',
        name: 'Whole-Home Network Infrastructure',
        detail: 'UniFi enterprise WiFi, structured cabling and managed switching — priced per sq ft over 4,000.',
        dynamicPrice: calcNetworkPrice,
        unit: 'system',
        alwaysSelected: true,
        hasQty: false
      }
    ]
  },
  {
    id: 'lighting',
    icon: '💡',
    name: 'Lighting and Controls',
    desc: 'Crestron whole-home lighting control, scene programming and commissioning.',
    features: [
      {
        id: 'l1',
        name: 'Crestron Lighting Allowance',
        detail: 'Allowance for Crestron Controls of Standard Fixtures — priced at $8 per sq ft.',
        dynamicPrice: calcLightingPrice,
        unit: 'system',
        hasQty: false
      },
      {
        id: 'l2',
        name: 'Crestron Tunable Lighting Allowance',
        detail: 'Allowance for Crestron Controls of Tunable DMF Fixtures — priced at $17 per sq ft.',
        dynamicPrice: calcTunableLightingPrice,
        unit: 'system',
        hasQty: false
      }
    ]
  },
  {
    id: 'shades',
    icon: '🪟',
    name: 'Motorized Window Treatments',
    desc: 'Crestron motorized shades, installed per window.',
    features: [
      {
        id: 'sh1',
        name: 'Motorized Window Treatments',
        detail: 'Allowance for Crestron motorized shades — per window, installed.',
        price: 2500,
        unit: 'window',
        hasQty: true,
        qty: 1
      }
    ]
  },
  {
    id: 'security',
    icon: '<svg viewBox="0 0 24 24" width="1em" height="1em" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M23 7l-7 5 7 5V7z"/><rect x="1" y="5" width="15" height="14" rx="2" ry="2"/><circle cx="8.5" cy="12" r="2.5" fill="currentColor" stroke="none" opacity="0.6"/></svg>',
    name: 'Security Cameras',
    desc: 'UniFi Protect professional surveillance system.',
    features: [
      {
        id: 'sec1',
        name: '8-Camera Security System',
        detail: 'UniFi Protect NVR + 8 4K cameras with AI, fully installed and configured.',
        price: 18000,
        unit: 'system',
        hasQty: false
      },
      {
        id: 'sec2',
        name: 'Additional Cameras',
        detail: 'UniFi 4K camera with AI, installed and configured — per camera.',
        price: 1400,
        unit: 'camera',
        hasQty: true,
        qty: 1
      }
    ]
  },
  {
    id: 'music',
    icon: '🎵',
    name: 'Music',
    desc: 'Whole-home distributed audio with Crestron control.',
    features: [
      {
        id: 'mus1',
        name: '8-Zone Crestron Music System',
        detail: 'Crestron distributed audio, 8 zones with in-ceiling/in-wall speakers, amplification, and full programming.',
        price: 28500,
        unit: 'system',
        hasQty: false
      }
    ],
    // Sub-options only shown when mus1 is selected
    musicSubOptions: [
      // ── Zone Additions ──────────────────────────────────
      {
        group: 'Zone Options',
        items: [
          {
            id: 'mus_extra_room',
            name: 'Additional Rooms with Speakers',
            detail: 'Speakers, wiring and amplification for music in additional areas.',
            unit: 'room',
            hasQty: true,
            qty: 1,
            customPrice: true   // handled by calcExtraRoomsPrice()
          },
          {
            id: 'mus_landscape_zone',
            name: 'Add a Landscape Speaker Zone',
            detail: 'Per area, eight satellite speakers and a 10" in-ground subwoofer, installed.',
            price: 11200,
            unit: 'zone',
            hasQty: true,
            qty: 1
          }
        ]
      },
      // ── Speaker Upgrades ─────────────────────────────────
      // dualUpgrade items: one line, two qty boxes
      // qtyOnePair → rooms with 1 pair upgrade, price = pricePer1 each
      // qtyTwoPair → rooms with 2 pairs upgrade, price = pricePer2 each
      {
        group: 'Speaker Upgrades',
        items: [
          {
            id: 'mus_extra_pair',
            name: 'Second Pair of Speakers in a Zone',
            detail: 'Add a second pair of in-ceiling/in-wall speakers to an existing zone — per zone.',
            price: 1670,
            unit: 'zone',
            hasQty: true,
            qty: 1
          },
          {
            id: 'mus_upg_invisible',
            name: 'Upgrade to Invisible Speakers',
            detail: 'Per room: $2,900 with one pair · $7,475 with two pairs',
            dualUpgrade: true,
            pricePer1: 2900,
            pricePer2: 7475
          },
          {
            id: 'mus_upg_small',
            name: 'Upgrade to Small Aperture Speakers',
            detail: 'Per room: $3,530 with one pair · $8,725 with two pairs',
            dualUpgrade: true,
            pricePer1: 3530,
            pricePer2: 8725
          },
          {
            id: 'mus_upg_outdoor',
            name: 'Upgrade to Outdoor Grade Speakers',
            detail: 'Per room: $40 with one pair · $1,750 with two pairs',
            dualUpgrade: true,
            pricePer1: 40,
            pricePer2: 1750
          }
        ]
      }
    ]
  },
  {
    id: 'video',
    icon: '🎬',
    name: 'Video',
    desc: 'Flush mounted televisions on service mount with all wiring, components and mounts recessed in the wall space.',
    features: [
      {
        id: 'tv55',
        name: '55" Television',
        detail: 'Television installed on a Future Automation service mount with all cabling, power and bracket concealed in the wall.',
        price: 4800,
        unit: 'TV',
        hasQty: true,
        qty: 1
      },
      {
        id: 'tv65',
        name: '65" Television',
        detail: 'Television installed on a Future Automation service mount with all cabling, power and bracket concealed in the wall.',
        price: 5800,
        unit: 'TV',
        hasQty: true,
        qty: 1
      },
      {
        id: 'tv75',
        name: '75" Television',
        detail: 'Television installed on a Future Automation service mount with all cabling, power and bracket concealed in the wall.',
        price: 6800,
        unit: 'TV',
        hasQty: true,
        qty: 1
      },
      {
        id: 'tv85',
        name: '85"+ Television',
        detail: 'Television installed on a Future Automation service mount with all cabling, power and bracket concealed in the wall.',
        price: 9600,
        unit: 'TV',
        hasQty: true,
        qty: 1
      }
    ],
    videoSubOptions: [
      {
        id: 'vid_surround',
        name: 'Surround Sound System',
        detail: 'Allowance for Crestron controlled surround sound, installed and programmed.',
        price: 17500,
        unit: 'system',
        hasQty: true,
        qty: 1
      },
      {
        id: 'vid_distributed',
        name: 'Distributed Video',
        detail: 'Centralized video distribution to all Televisions with Crestron control. Includes four sources, expandable to eight.',
        tvPrice: true,
        unit: 'system',
        hasQty: false
      }
    ]
  },
  {
    id: 'climate',
    icon: '🌡️',
    name: 'Climate Control',
    desc: 'Crestron control of HVAC zones via thermostat and app.',
    features: [
      {
        id: 'clim1',
        name: 'Forced Air Zone Control',
        detail: 'Crestron Horizon thermostat to control forced air zones.',
        price: 900,
        unit: 'zone',
        hasQty: true,
        qty: 1
      }
    ]
  },
  {
    id: 'entry',
    icon: '🚪',
    name: 'Entry and Access Control',
    desc: 'Gate entry systems, video doorbells and access control.',
    features: [
      {
        id: 'ent1',
        name: 'Gate Entry System',
        detail: 'Unifi intercom and gate controller for one vehicle or pedestrian gate, installed.',
        price: 3500,
        unit: 'system',
        hasQty: true,
        qty: 1
      },
      {
        id: 'ent2',
        name: 'Video Doorbell',
        detail: 'Unifi video doorbell with visitor and package camera, installed.',
        price: 900,
        unit: 'unit',
        hasQty: false
      }
    ]
  }
];

// ─────────────────────────────────────────────────────────────
// STATE
// ─────────────────────────────────────────────────────────────
let state = {
  currentStep: 0,
  maxStep: 0,
  selectedCategories: new Set(),
  selectedFeatures: {},
  client: {},
  activeChip: null,
  notes: {}   // catId → note text
};

function getFeaturePrice(f) {
  return f.dynamicPrice ? f.dynamicPrice() : f.price;
}

// ─────────────────────────────────────────────────────────────
// INIT
// ─────────────────────────────────────────────────────────────
function init() {
  CATEGORIES.forEach(cat => {
    if (cat.locked) {
      state.selectedCategories.add(cat.id);
      cat.features.forEach(f => {
        state.selectedFeatures[f.id] = { qty: f.qty || 1 };
      });
    }
  });
  renderCategories();
  updateProgress(0);
}

// ─────────────────────────────────────────────────────────────
// CATEGORIES
// ─────────────────────────────────────────────────────────────
function renderCategories() {
  const grid = document.getElementById('categories-grid');
  grid.innerHTML = CATEGORIES.map(cat => {
    const sel = state.selectedCategories.has(cat.id);
    const isLocked = !!cat.locked;
    return `
      <div class="category-card ${isLocked ? 'locked' : (sel ? 'selected' : '')}"
           ${isLocked ? '' : `onclick="toggleCategory('${cat.id}')"`}
           id="cat-${cat.id}">
        <div class="category-check">${(sel || isLocked) ? '✓' : ''}</div>
        ${isLocked ? '<div class="lock-badge">Included</div>' : ''}
        <span class="category-icon">${cat.icon}</span>
        <div class="category-name">${cat.name}</div>
        <div class="category-desc">${cat.desc}</div>
      </div>
    `;
  }).join('');
}

function toggleCategory(id) {
  const cat = CATEGORIES.find(c => c.id === id);
  if (!cat || cat.locked) return;
  if (state.selectedCategories.has(id)) {
    state.selectedCategories.delete(id);
    cat.features.forEach(f => delete state.selectedFeatures[f.id]);
    // Clear music sub-options
    if (cat.musicSubOptions) {
      cat.musicSubOptions.forEach(group => {
        group.items.forEach(sf => delete state.selectedFeatures[sf.id]);
      });
    }
    // Clear video sub-options
    if (cat.videoSubOptions) {
      cat.videoSubOptions.forEach(sf => delete state.selectedFeatures[sf.id]);
    }
  } else {
    state.selectedCategories.add(id);
  }
  renderCategories();
}

// ─────────────────────────────────────────────────────────────
// FEATURES
// ─────────────────────────────────────────────────────────────
function goToFeatures() {
  renderFeatures();
  goTo(2);
}

// Save any typed notes from the DOM into state before a full re-render
function saveNotesFromDOM() {
  ['music', 'video'].forEach(catId => {
    const el = document.getElementById('notes-' + catId);
    if (el) state.notes[catId] = el.value;
  });
}

function renderFeatures() {
  saveNotesFromDOM();
  const selected = CATEGORIES.filter(c => state.selectedCategories.has(c.id));
  const chips = document.getElementById('category-chips');
  const container = document.getElementById('features-container');

  chips.innerHTML = selected.map((cat, i) => {
    const isActive = state.activeChip ? state.activeChip === cat.id : i === 0;
    return `<span class="chip ${isActive ? 'active' : ''}"
                  onclick="scrollToSection('${cat.id}', this)">${cat.icon} ${cat.name}</span>`;
  }).join('');

  container.innerHTML = selected.map(cat => {
    const isLockedSection = !!cat.locked;
    const hasNotes = cat.id === 'music' || cat.id === 'video';

    const itemsHTML = cat.features.map(f => {
      const isAlways = !!(f.alwaysSelected || isLockedSection);
      const sel = isAlways ? true : !!state.selectedFeatures[f.id];
      const qty = (state.selectedFeatures[f.id]?.qty) || f.qty || 1;
      const price = getFeaturePrice(f);
      const lineTotal = f.hasQty ? price * qty : price;

      let mainItem = `
        <div class="feature-item ${isAlways ? 'locked-item' : (sel ? 'selected' : '')}"
             id="fi-${f.id}"
             ${isAlways ? '' : `onclick="toggleFeature('${f.id}')"`}>
          <div class="feature-item-left">
            <div class="feature-checkbox">${sel ? '✓' : ''}</div>
            <div>
              <div class="feature-name">${f.name}</div>
              <div class="feature-detail">${f.detail}</div>
            </div>
          </div>
          ${f.hasQty && sel && !isAlways ? `
            <div class="qty-input" onclick="event.stopPropagation()">
              <button class="qty-btn" onclick="changeQty('${f.id}', -1)">−</button>
              <span class="qty-display" id="qty-${f.id}">${qty}</span>
              <button class="qty-btn" onclick="changeQty('${f.id}', 1)">+</button>
            </div>
          ` : ''}
          <div class="feature-price">
            $${lineTotal.toLocaleString()}
            <div class="feature-price-note">${f.hasQty && !isAlways && sel ? `× ${qty} ${f.unit}${qty > 1 ? 's' : ''}` : `per ${f.unit}`}</div>
          </div>
        </div>
      `;

      // Render music sub-options if mus1 is selected
      if (f.id === 'mus1' && sel && cat.musicSubOptions) {
        mainItem += renderMusicSubOptions(cat.musicSubOptions);
      }

      return mainItem;
    }).join('');

    // Render video sub-options once at category level, always visible when video is selected
    const videoSubHTML = cat.videoSubOptions ? renderVideoSubOptions(cat.videoSubOptions) : '';

    const notesVal = (state.notes[cat.id] || '').replace(/"/g, '&quot;');
    const notesHTML = hasNotes ? `
      <div class="section-notes-wrapper">
        <div class="section-notes-label"><span>📝</span> Notes for ${cat.name}</div>
        <textarea class="section-notes-textarea"
                  id="notes-${cat.id}"
                  placeholder="Add any specific requirements, room names, preferences, or install notes for this system..."
                  oninput="state.notes['${cat.id}'] = this.value">${notesVal}</textarea>
      </div>
    ` : '';

    return `
      <div class="features-section" id="section-${cat.id}">
        <div class="features-section-title">
          <span class="icon">${cat.icon}</span> ${cat.name}
        </div>
        ${isLockedSection ? '<div class="section-locked-note">Included in all configurations</div>' : ''}
        <div class="feature-items">${itemsHTML}</div>
        ${videoSubHTML}
        ${notesHTML}
      </div>
    `;
  }).join('');
}

function renderMusicSubOptions(subOptionGroups) {
  return `<div class="music-suboptions" id="music-suboptions-panel">
    <div class="music-suboptions-header">🎛️ System Options &amp; Upgrades</div>
    ${buildMusicSubOptionsInner(subOptionGroups)}
  </div>`;
}

function renderVideoSubOptions(items) {
  let html = `<div class="music-suboptions" id="video-suboptions-panel">
    <div class="music-suboptions-header">🎛️ Video System Upgrades</div>`;

  for (const f of items) {
    const sel = !!state.selectedFeatures[f.id];
    const qty = state.selectedFeatures[f.id]?.qty || f.qty || 1;
    const lineTotal = getVideoSubPrice(f, qty);

    html += `
      <div class="feature-item sub-option ${sel ? 'selected' : ''}"
           id="fi-${f.id}"
           onclick="toggleVideoSub('${f.id}')">
        <div class="feature-item-left">
          <div class="feature-checkbox">${sel ? '✓' : ''}</div>
          <div>
            <div class="feature-name">${f.name}</div>
            <div class="feature-detail">${f.detail}</div>
          </div>
        </div>
        ${f.hasQty && sel ? `
          <div class="qty-input" onclick="event.stopPropagation()">
            <button class="qty-btn" onclick="changeVideoSubQty('${f.id}', -1)">−</button>
            <span class="qty-display" id="qty-${f.id}">${qty}</span>
            <button class="qty-btn" onclick="changeVideoSubQty('${f.id}', 1)">+</button>
          </div>
        ` : ''}
        <div class="feature-price">
          $${lineTotal.toLocaleString()}
          ${f.tvPrice && sel
            ? `<div class="feature-price-note">${countSelectedTVs()} TV${countSelectedTVs()!==1?'s':''}</div>`
            : f.hasQty && sel
              ? `<div class="feature-price-note">× ${qty} ${f.unit}${qty>1?'s':''}</div>`
              : `<div class="feature-price-note">per ${f.unit}</div>`
          }
        </div>
      </div>
    `;
  }

  html += `</div>`;
  return html;
}

function getVideoSubPrice(f, qty) {
  if (f.tvPrice) return calcDistributedVideoPrice();
  return (f.price || 0) * (f.hasQty ? qty : 1);
}

function toggleVideoSub(fid) {
  const f = findVideoSub(fid);
  if (!f) return;
  if (state.selectedFeatures[fid]) {
    delete state.selectedFeatures[fid];
  } else {
    state.selectedFeatures[fid] = { qty: f.qty || 1 };
  }
  refreshVideoSubPanel();
}

function changeVideoSubQty(fid, delta) {
  if (!state.selectedFeatures[fid]) return;
  state.selectedFeatures[fid].qty = Math.max(1, (state.selectedFeatures[fid].qty || 1) + delta);
  refreshVideoSubPanel();
}

function findVideoSub(fid) {
  const videoCat = CATEGORIES.find(c => c.id === 'video');
  return videoCat?.videoSubOptions?.find(f => f.id === fid) || null;
}

function refreshVideoSubPanel() {
  const videoCat = CATEGORIES.find(c => c.id === 'video');
  if (!videoCat?.videoSubOptions) return;
  const panel = document.getElementById('video-suboptions-panel');
  if (!panel) return;
  // Patch each item in place — no innerHTML replacement, no flash
  for (const f of videoCat.videoSubOptions) {
    const el = document.getElementById('fi-' + f.id);
    if (!el) continue;
    const sel = !!state.selectedFeatures[f.id];
    const qty = state.selectedFeatures[f.id]?.qty || f.qty || 1;
    const lineTotal = getVideoSubPrice(f, qty);

    el.classList.toggle('selected', sel);
    const cb = el.querySelector('.feature-checkbox');
    if (cb) cb.textContent = sel ? '✓' : '';

    // Qty controls
    const existingQty = el.querySelector('.qty-input');
    if (f.hasQty) {
      if (sel && !existingQty) {
        const priceDiv = el.querySelector('.feature-price');
        const qtyDiv = document.createElement('div');
        qtyDiv.className = 'qty-input';
        qtyDiv.setAttribute('onclick', 'event.stopPropagation()');
        qtyDiv.innerHTML = `
          <button class="qty-btn" onclick="changeVideoSubQty('${f.id}', -1)">−</button>
          <span class="qty-display" id="qty-${f.id}">${qty}</span>
          <button class="qty-btn" onclick="changeVideoSubQty('${f.id}', 1)">+</button>
        `;
        el.insertBefore(qtyDiv, priceDiv);
      } else if (!sel && existingQty) {
        existingQty.remove();
      } else if (sel && existingQty) {
        const disp = document.getElementById('qty-' + f.id);
        if (disp) disp.textContent = qty;
      }
    }

    // Price
    const priceDiv = el.querySelector('.feature-price');
    if (priceDiv) {
      const tvCount = countSelectedTVs();
      const note = f.tvPrice && sel
        ? `${tvCount} TV${tvCount!==1?'s':''}`
        : f.hasQty && sel
          ? `× ${qty} ${f.unit}${qty>1?'s':''}`
          : `per ${f.unit}`;
      priceDiv.innerHTML = `$${lineTotal.toLocaleString()}<div class="feature-price-note">${note}</div>`;
    }
  }
}

function buildMusicSubOptionsInner(subOptionGroups) {
  let html = '';

  for (const group of subOptionGroups) {
    html += `<div class="music-group-label">${group.group}</div>`;
    for (const f of group.items) {
      if (f.dualUpgrade) {
        html += renderDualUpgradeItem(f);
      } else {
        const sel = !!state.selectedFeatures[f.id];
        const qty = state.selectedFeatures[f.id]?.qty || f.qty || 1;
        const lineTotal = getMusicSubPrice(f, qty);

        html += `
          <div class="feature-item sub-option ${sel ? 'selected' : ''}"
               id="fi-${f.id}"
               onclick="toggleMusicSub('${f.id}')">
            <div class="feature-item-left">
              <div class="feature-checkbox">${sel ? '✓' : ''}</div>
              <div>
                <div class="feature-name">${f.name}</div>
                <div class="feature-detail">${f.detail}</div>
              </div>
            </div>
            ${sel ? `
              <div class="qty-input" onclick="event.stopPropagation()">
                <button class="qty-btn" onclick="changeMusicSubQty('${f.id}', -1)">−</button>
                <span class="qty-display" id="qty-${f.id}">${qty}</span>
                <button class="qty-btn" onclick="changeMusicSubQty('${f.id}', 1)">+</button>
              </div>
            ` : ''}
            <div class="feature-price">
              $${lineTotal.toLocaleString()}
              <div class="feature-price-note">${sel ? `× ${qty} ${f.unit}${qty > 1 ? 's' : ''}` : `per ${f.unit}`}</div>
            </div>
          </div>
        `;
      }
    }
  }

  return html;
}

function renderDualUpgradeItem(f) {
  // State stores: { q1: qty of 1-pair rooms, q2: qty of 2-pair rooms }
  const st = state.selectedFeatures[f.id];
  const sel = !!st;
  const q1 = st?.q1 || 0;
  const q2 = st?.q2 || 0;
  const total = calcDualUpgradeTotal(f, q1, q2);

  return `
    <div class="feature-item sub-option ${sel ? 'selected' : ''}"
         id="fi-${f.id}"
         onclick="toggleDualUpgrade('${f.id}')">
      <div class="feature-item-left">
        <div class="feature-checkbox">${sel ? '✓' : ''}</div>
        <div>
          <div class="feature-name">${f.name}</div>
          <div class="feature-detail">${f.detail}</div>
        </div>
      </div>
      ${sel ? `
        <div class="dual-qty-wrapper" onclick="event.stopPropagation()">
          <div class="dual-qty-block">
            <div class="dual-qty-label">1 Pair</div>
            <div class="dual-qty-price">$${f.pricePer1.toLocaleString()} ea</div>
            <div class="qty-input">
              <button class="qty-btn" onclick="changeDualQty('${f.id}', 1, -1)">−</button>
              <span class="qty-display" id="dq1-${f.id}">${q1}</span>
              <button class="qty-btn" onclick="changeDualQty('${f.id}', 1, 1)">+</button>
            </div>
          </div>
          <div style="color:rgba(28,26,23,0.2);font-size:18px;align-self:flex-end;padding-bottom:4px">|</div>
          <div class="dual-qty-block">
            <div class="dual-qty-label">2 Pairs</div>
            <div class="dual-qty-price">$${f.pricePer2.toLocaleString()} ea</div>
            <div class="qty-input">
              <button class="qty-btn" onclick="changeDualQty('${f.id}', 2, -1)">−</button>
              <span class="qty-display" id="dq2-${f.id}">${q2}</span>
              <button class="qty-btn" onclick="changeDualQty('${f.id}', 2, 1)">+</button>
            </div>
          </div>
        </div>
        <div class="upgrade-total">
          $${total.toLocaleString()}
          <div class="upgrade-total-note">total</div>
        </div>
      ` : `
        <div class="feature-price">
          <div style="font-size:12px">$${f.pricePer1.toLocaleString()} / $${f.pricePer2.toLocaleString()}</div>
          <div class="feature-price-note">1 pair / 2 pairs</div>
        </div>
      `}
    </div>
  `;
}

function calcDualUpgradeTotal(f, q1, q2) {
  return (q1 * f.pricePer1) + (q2 * f.pricePer2);
}

function getMusicSubPrice(f, qty) {
  if (f.customPrice) return calcExtraRoomsPrice(qty);
  if (f.upgradePrice) return calcUpgradePrice(f.upgradePrice, qty);
  return (f.price || 0) * qty;
}

function getMusicSubTotal(f) {
  // For dualUpgrade items, use q1/q2 from state
  if (f.dualUpgrade) {
    const st = state.selectedFeatures[f.id];
    if (!st) return 0;
    return calcDualUpgradeTotal(f, st.q1 || 0, st.q2 || 0);
  }
  const qty = state.selectedFeatures[f.id]?.qty || f.qty || 1;
  return getMusicSubPrice(f, qty);
}

function toggleMusicSub(fid) {
  const f = findMusicSub(fid);
  if (!f) return;
  if (state.selectedFeatures[fid]) {
    delete state.selectedFeatures[fid];
  } else {
    state.selectedFeatures[fid] = { qty: f.qty || 1 };
  }
  refreshMusicSubPanel();
}

function changeMusicSubQty(fid, delta) {
  if (!state.selectedFeatures[fid]) return;
  const newQty = Math.max(1, (state.selectedFeatures[fid].qty || 1) + delta);
  state.selectedFeatures[fid].qty = newQty;
  refreshMusicSubPanel();
}

function toggleDualUpgrade(fid) {
  if (state.selectedFeatures[fid]) {
    delete state.selectedFeatures[fid];
  } else {
    state.selectedFeatures[fid] = { q1: 1, q2: 0 };
  }
  refreshMusicSubPanel();
}

function changeDualQty(fid, pairType, delta) {
  if (!state.selectedFeatures[fid]) return;
  const key = pairType === 1 ? 'q1' : 'q2';
  const current = state.selectedFeatures[fid][key] || 0;
  state.selectedFeatures[fid][key] = Math.max(0, current + delta);
  refreshMusicSubPanel();
}

// ── Surgical DOM updaters — zero flash ───────────────────────

// Update a single standard sub-option row in place
function patchStandardSubItem(f) {
  const el = document.getElementById('fi-' + f.id);
  if (!el) return;
  const sel = !!state.selectedFeatures[f.id];
  const qty = state.selectedFeatures[f.id]?.qty || f.qty || 1;
  const lineTotal = getMusicSubPrice(f, qty);

  // Toggle selected class
  el.classList.toggle('selected', sel);

  // Checkbox
  const cb = el.querySelector('.feature-checkbox');
  if (cb) cb.textContent = sel ? '✓' : '';

  // Qty controls — add or remove as needed
  const existingQty = el.querySelector('.qty-input');
  if (sel && !existingQty) {
    // Insert qty controls before the price div
    const priceDiv = el.querySelector('.feature-price');
    const qtyDiv = document.createElement('div');
    qtyDiv.className = 'qty-input';
    qtyDiv.setAttribute('onclick', 'event.stopPropagation()');
    qtyDiv.innerHTML = `
      <button class="qty-btn" onclick="changeMusicSubQty('${f.id}', -1)">−</button>
      <span class="qty-display" id="qty-${f.id}">${qty}</span>
      <button class="qty-btn" onclick="changeMusicSubQty('${f.id}', 1)">+</button>
    `;
    el.insertBefore(qtyDiv, priceDiv);
  } else if (!sel && existingQty) {
    existingQty.remove();
  } else if (sel && existingQty) {
    const disp = document.getElementById('qty-' + f.id);
    if (disp) disp.textContent = qty;
  }

  // Price
  const priceDiv = el.querySelector('.feature-price');
  if (priceDiv) {
    priceDiv.innerHTML = `$${lineTotal.toLocaleString()}<div class="feature-price-note">${sel ? `× ${qty} ${f.unit}${qty > 1 ? 's' : ''}` : `per ${f.unit}`}</div>`;
  }
}

// Update a dual-upgrade row in place
function patchDualUpgradeItem(f) {
  const el = document.getElementById('fi-' + f.id);
  if (!el) return;
  const st = state.selectedFeatures[f.id];
  const sel = !!st;
  const q1 = st?.q1 || 0;
  const q2 = st?.q2 || 0;
  const total = calcDualUpgradeTotal(f, q1, q2);

  el.classList.toggle('selected', sel);
  const cb = el.querySelector('.feature-checkbox');
  if (cb) cb.textContent = sel ? '✓' : '';

  const existingWrapper = el.querySelector('.dual-qty-wrapper');
  const existingTotal = el.querySelector('.upgrade-total');
  const existingPrice = el.querySelector('.feature-price');

  if (sel) {
    // Remove collapsed price display if present
    if (existingPrice) existingPrice.remove();

    if (existingWrapper) {
      // Just update counts and total
      const dq1 = document.getElementById('dq1-' + f.id);
      const dq2 = document.getElementById('dq2-' + f.id);
      if (dq1) dq1.textContent = q1;
      if (dq2) dq2.textContent = q2;
      if (existingTotal) existingTotal.innerHTML = `$${total.toLocaleString()}<div class="upgrade-total-note">total</div>`;
    } else {
      // Build the dual-qty wrapper from scratch
      const wrapper = document.createElement('div');
      wrapper.className = 'dual-qty-wrapper';
      wrapper.setAttribute('onclick', 'event.stopPropagation()');
      wrapper.innerHTML = `
        <div class="dual-qty-block">
          <div class="dual-qty-label">1 Pair</div>
          <div class="dual-qty-price">$${f.pricePer1.toLocaleString()} ea</div>
          <div class="qty-input">
            <button class="qty-btn" onclick="changeDualQty('${f.id}', 1, -1)">−</button>
            <span class="qty-display" id="dq1-${f.id}">${q1}</span>
            <button class="qty-btn" onclick="changeDualQty('${f.id}', 1, 1)">+</button>
          </div>
        </div>
        <div style="color:rgba(28,26,23,0.2);font-size:18px;align-self:flex-end;padding-bottom:4px">|</div>
        <div class="dual-qty-block">
          <div class="dual-qty-label">2 Pairs</div>
          <div class="dual-qty-price">$${f.pricePer2.toLocaleString()} ea</div>
          <div class="qty-input">
            <button class="qty-btn" onclick="changeDualQty('${f.id}', 2, -1)">−</button>
            <span class="qty-display" id="dq2-${f.id}">${q2}</span>
            <button class="qty-btn" onclick="changeDualQty('${f.id}', 2, 1)">+</button>
          </div>
        </div>
      `;
      const totalDiv = document.createElement('div');
      totalDiv.className = 'upgrade-total';
      totalDiv.innerHTML = `$${total.toLocaleString()}<div class="upgrade-total-note">total</div>`;
      el.appendChild(wrapper);
      el.appendChild(totalDiv);
    }
  } else {
    // Collapsed — remove controls, show static price
    if (existingWrapper) existingWrapper.remove();
    if (existingTotal) existingTotal.remove();
    if (!el.querySelector('.feature-price')) {
      const priceDiv = document.createElement('div');
      priceDiv.className = 'feature-price';
      priceDiv.innerHTML = `<div style="font-size:12px">$${f.pricePer1.toLocaleString()} / $${f.pricePer2.toLocaleString()}</div><div class="feature-price-note">1 pair / 2 pairs</div>`;
      el.appendChild(priceDiv);
    }
  }
}

function refreshMusicSubPanel() {
  // Find the changed item and patch only that element — no innerHTML replacement, no flash
  // Since we don't know which item changed, patch all of them (still no DOM destruction)
  const musicCat = CATEGORIES.find(c => c.id === 'music');
  if (!musicCat?.musicSubOptions) return;
  if (!document.getElementById('music-suboptions-panel')) return;

  for (const group of musicCat.musicSubOptions) {
    for (const f of group.items) {
      if (f.dualUpgrade) {
        patchDualUpgradeItem(f);
      } else {
        patchStandardSubItem(f);
      }
    }
  }
}

function findMusicSub(fid) {
  const musicCat = CATEGORIES.find(c => c.id === 'music');
  if (!musicCat || !musicCat.musicSubOptions) return null;
  for (const group of musicCat.musicSubOptions) {
    const f = group.items.find(x => x.id === fid);
    if (f) return f;
  }
  return null;
}

function toggleFeature(fid) {
  const f = findFeature(fid);
  if (!f) return;
  const cat = CATEGORIES.find(c => c.features.some(x => x.id === fid));
  if (!cat || cat.locked || f.alwaysSelected) return;

  if (state.selectedFeatures[fid]) {
    delete state.selectedFeatures[fid];
    // If unchecking music system, clear all sub-options
    if (fid === 'mus1' && cat.musicSubOptions) {
      cat.musicSubOptions.forEach(group => {
        group.items.forEach(sf => delete state.selectedFeatures[sf.id]);
      });
    }
    // If unchecking a TV, clear video sub-options if no TVs remain
    if (['tv55','tv65','tv75','tv85'].includes(fid)) {
      if (countSelectedTVs() === 0 && cat.videoSubOptions) {
        cat.videoSubOptions.forEach(sf => delete state.selectedFeatures[sf.id]);
      }
    }
  } else {
    state.selectedFeatures[fid] = { qty: f.qty || 1 };
    // Lighting options are mutually exclusive — selecting one deselects the other
    if (fid === 'l1') delete state.selectedFeatures['l2'];
    if (fid === 'l2') delete state.selectedFeatures['l1'];
  }

  // Surgical update for video items — patch in place, no full re-render
  if (['tv55','tv65','tv75','tv85'].includes(fid)) {
    patchFeatureItem(f, cat);
    refreshVideoSubPanel();
    return;
  }

  renderFeatures();
}

function changeQty(fid, delta) {
  if (!state.selectedFeatures[fid]) return;
  const newQty = Math.max(1, (state.selectedFeatures[fid].qty || 1) + delta);
  state.selectedFeatures[fid].qty = newQty;

  // Surgical update for TV qty changes
  if (['tv55','tv65','tv75','tv85'].includes(fid)) {
    const f = findFeature(fid);
    const cat = CATEGORIES.find(c => c.features.some(x => x.id === fid));
    if (f && cat) patchFeatureItem(f, cat);
    refreshVideoSubPanel();
    return;
  }

  renderFeatures();
}

// Surgically patch a single feature-item row in place (no DOM destruction, no flash)
function patchFeatureItem(f, cat) {
  const el = document.getElementById('fi-' + f.id);
  if (!el) return;

  const sel = !!state.selectedFeatures[f.id];
  const qty = state.selectedFeatures[f.id]?.qty || f.qty || 1;
  const price = getFeaturePrice(f);
  const lineTotal = f.hasQty ? price * qty : price;
  const isAlways = !!(f.alwaysSelected || cat.locked);

  // Toggle selected class
  el.classList.toggle('selected', sel && !isAlways);

  // Checkbox
  const cb = el.querySelector('.feature-checkbox');
  if (cb) cb.textContent = sel ? '✓' : '';

  // Qty controls — add or remove
  const existingQty = el.querySelector('.qty-input');
  if (f.hasQty && sel && !isAlways) {
    if (!existingQty) {
      const priceDiv = el.querySelector('.feature-price');
      const qtyDiv = document.createElement('div');
      qtyDiv.className = 'qty-input';
      qtyDiv.setAttribute('onclick', 'event.stopPropagation()');
      qtyDiv.innerHTML = `
        <button class="qty-btn" onclick="changeQty('${f.id}', -1)">−</button>
        <span class="qty-display" id="qty-${f.id}">${qty}</span>
        <button class="qty-btn" onclick="changeQty('${f.id}', 1)">+</button>
      `;
      el.insertBefore(qtyDiv, priceDiv);
    } else {
      const disp = document.getElementById('qty-' + f.id);
      if (disp) disp.textContent = qty;
    }
  } else if (existingQty) {
    existingQty.remove();
  }

  // Price display
  const priceDiv = el.querySelector('.feature-price');
  if (priceDiv) {
    const note = f.hasQty && sel && !isAlways
      ? `× ${qty} ${f.unit}${qty > 1 ? 's' : ''}`
      : `per ${f.unit}`;
    priceDiv.innerHTML = `$${lineTotal.toLocaleString()}<div class="feature-price-note">${note}</div>`;
  }
}

function findFeature(fid) {
  for (const cat of CATEGORIES) {
    const f = cat.features.find(x => x.id === fid);
    if (f) return f;
  }
  // Also search music sub-options
  return findMusicSub(fid);
}

function scrollToSection(catId, chip) {
  state.activeChip = catId;
  document.querySelectorAll('.chip').forEach(c => c.classList.remove('active'));
  chip.classList.add('active');
  const el = document.getElementById('section-' + catId);
  if (el) el.scrollIntoView({ behavior: 'smooth', block: 'start' });
}

// ─────────────────────────────────────────────────────────────
// QUOTE
// ─────────────────────────────────────────────────────────────
function buildQuote() {
  saveNotesFromDOM();
  state.client = {
    first: document.getElementById('client-first').value || '—',
    last: document.getElementById('client-last').value || '—',
    email: document.getElementById('client-email').value || '—',
    phone: document.getElementById('client-phone').value || '—',
    address: document.getElementById('client-address').value || '—',
    sqft: document.getElementById('sq-footage').value || '2400'
  };

  document.getElementById('quote-date').textContent =
    `Prepared: ${new Date().toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' })} · Personal Technology · ptech.la`;

  document.getElementById('quote-client-meta').innerHTML = `
    <div class="client-meta-item">
      <span class="client-meta-label">Client Name</span>
      <span class="client-meta-value">${state.client.first} ${state.client.last}</span>
    </div>
    <div class="client-meta-item">
      <span class="client-meta-label">Square Footage</span>
      <span class="client-meta-value">${parseInt(state.client.sqft).toLocaleString()} sq ft</span>
    </div>
    <div class="client-meta-item">
      <span class="client-meta-label">Email</span>
      <span class="client-meta-value">${state.client.email}</span>
    </div>
    <div class="client-meta-item">
      <span class="client-meta-label">Phone</span>
      <span class="client-meta-value">${state.client.phone}</span>
    </div>
    <div class="client-meta-item" style="grid-column:1/-1">
      <span class="client-meta-label">Property Address</span>
      <span class="client-meta-value">${state.client.address}</span>
    </div>
  `;

  const quoteSections = document.getElementById('quote-sections');
  const summaryLines = document.getElementById('summary-lines');
  let grandTotal = 0;
  let sectionsHTML = '';
  let summaryHTML = '';

  const selected = CATEGORIES.filter(c => state.selectedCategories.has(c.id));

  for (const cat of selected) {
    let catTotal = 0;
    let rowsHTML = '';

    for (const f of cat.features) {
      const isAlways = !!(f.alwaysSelected || cat.locked);
      const isSel = isAlways ? true : !!state.selectedFeatures[f.id];
      if (!isSel) continue;

      const qty = state.selectedFeatures[f.id]?.qty || f.qty || 1;
      const unitPrice = getFeaturePrice(f);
      const line = f.hasQty ? unitPrice * qty : unitPrice;
      catTotal += line;

      rowsHTML += `
        <div class="quote-item">
          <div>
            <div class="quote-item-name">${f.name}</div>
            <div class="quote-item-detail">${f.detail}${f.hasQty && !isAlways ? ` · Qty: ${qty}` : ''}</div>
          </div>
          <div class="quote-item-price">$${line.toLocaleString()}</div>
        </div>
      `;

      // If this is the music system, add any selected sub-options
      if (f.id === 'mus1' && cat.musicSubOptions) {
        for (const group of cat.musicSubOptions) {
          for (const sf of group.items) {
            if (!state.selectedFeatures[sf.id]) continue;
            const sline = getMusicSubTotal(sf);
            if (sline === 0) continue;
            let qtyDetail = '';
            if (sf.dualUpgrade) {
              const st = state.selectedFeatures[sf.id];
              const parts = [];
              if (st.q1 > 0) parts.push(`${st.q1} room${st.q1>1?'s':''} × 1 pair`);
              if (st.q2 > 0) parts.push(`${st.q2} room${st.q2>1?'s':''} × 2 pairs`);
              qtyDetail = parts.join(', ');
            } else {
              const sqty = state.selectedFeatures[sf.id].qty || 1;
              qtyDetail = `Qty: ${sqty}`;
            }
            catTotal += sline;
            rowsHTML += `
              <div class="quote-item" style="padding-left:36px">
                <div>
                  <div class="quote-item-name" style="font-size:12px">↳ ${sf.name}</div>
                  <div class="quote-item-detail">${sf.detail} · ${qtyDetail}</div>
                </div>
                <div class="quote-item-price">$${sline.toLocaleString()}</div>
              </div>
            `;
          }
        }
      }
    }

    // Video sub-options — appended once after all TV features are processed
    if (cat.videoSubOptions) {
      for (const sf of cat.videoSubOptions) {
        if (!state.selectedFeatures[sf.id]) continue;
        const sqty = state.selectedFeatures[sf.id].qty || 1;
        const sline = getVideoSubPrice(sf, sqty);
        const qtyDetail = sf.tvPrice
          ? `${countSelectedTVs()} TVs`
          : `Qty: ${sqty}`;
        catTotal += sline;
        rowsHTML += `
          <div class="quote-item" style="padding-left:36px">
            <div>
              <div class="quote-item-name" style="font-size:12px">↳ ${sf.name}</div>
              <div class="quote-item-detail">${sf.detail} · ${qtyDetail}</div>
            </div>
            <div class="quote-item-price">$${sline.toLocaleString()}</div>
          </div>
        `;
      }
    }

    if (!rowsHTML) continue;

    grandTotal += catTotal;
    const catNotes = state.notes[cat.id] || '';
    sectionsHTML += `
      <div class="quote-section">
        <div class="quote-section-header">
          <span>${cat.icon}</span>
          <span class="quote-section-title">${cat.name}</span>
        </div>
        ${rowsHTML}
        <div class="quote-item" style="background:var(--bg)">
          <div class="quote-item-name" style="font-family:'DM Mono',monospace;font-size:11px;letter-spacing:.12em;text-transform:uppercase;color:var(--slate)">Category Subtotal</div>
          <div class="quote-item-price">$${catTotal.toLocaleString()}</div>
        </div>
        ${catNotes ? `<div style="padding:12px 20px 14px;border-top:1px solid var(--border)">
          <div style="font-family:'DM Mono',monospace;font-size:9px;letter-spacing:0.14em;text-transform:uppercase;color:var(--slate);margin-bottom:6px">Notes</div>
          <div style="font-size:13px;color:var(--slate);font-weight:300;line-height:1.6;white-space:pre-wrap">${catNotes}</div>
        </div>` : ''}
      </div>
    `;

    summaryHTML += `
      <div class="summary-line">
        <span>${cat.icon} ${cat.name}</span>
        <span class="val">$${catTotal.toLocaleString()}</span>
      </div>
    `;
  }

  // Calculate 7% sales tax before rendering
  const salesTax = Math.round(grandTotal * 0.07);
  const grandWithTax = grandTotal + salesTax;

  quoteSections.innerHTML = (sectionsHTML || `<div style="padding:48px;text-align:center;color:var(--slate);font-size:14px">No features selected.</div>`) + 
    (grandTotal > 0 ? `
      <div class="quote-section">
        <div class="quote-section-header">
          <span style="font-size:14px">🧾</span>
          <span class="quote-section-title">Sales Tax</span>
        </div>
        <div class="quote-item">
          <div>
            <div class="quote-item-name">Estimated Sales Tax</div>
          </div>
          <div class="quote-item-price">$${salesTax.toLocaleString()}</div>
        </div>
      </div>
    ` : '');

  summaryHTML += `
    <div class="summary-line">
      <span>🧾 Sales Tax</span>
      <span class="val">$${salesTax.toLocaleString()}</span>
    </div>
  `;

  summaryLines.innerHTML = summaryHTML;
  document.getElementById('grand-total').textContent = '$' + grandWithTax.toLocaleString();
}

// ─────────────────────────────────────────────────────────────
// NAVIGATION
// ─────────────────────────────────────────────────────────────
function goTo(n) {
  if (n === 3) buildQuote();
  document.querySelectorAll('.step').forEach(el => el.classList.remove('active'));
  const stepId = n === 3 ? 'step-quote' : 'step-' + n;
  document.getElementById(stepId).classList.add('active');
  state.currentStep = n;
  state.maxStep = Math.max(state.maxStep, n);
  updateProgress(n);
  // Defer scroll to next frame so iOS Safari paints the display change first
  requestAnimationFrame(() => window.scrollTo({ top: 0, behavior: 'instant' }));
}

function updateProgress(n) {
  const fill = (n / 3) * 100;
  document.getElementById('progress-fill').style.width = fill + '%';
  for (let i = 0; i < 4; i++) {
    const el = document.getElementById('pl-' + i);
    el.classList.remove('active', 'done', 'reachable');
    if (i < n) el.classList.add('done');
    else if (i === n) el.classList.add('active');
    else if (i <= state.maxStep) el.classList.add('reachable');
  }
}

function resetTool() {
  if (!confirm('Start a new quote? This will clear all current selections.')) return;
  state = { currentStep: 0, maxStep: 0, selectedCategories: new Set(), selectedFeatures: {}, client: {}, activeChip: null, notes: {} };
  document.querySelectorAll('input').forEach(el => {
    if (el.id === 'sq-footage') el.value = '2400';
    else el.value = '';
  });
  CATEGORIES.forEach(cat => {
    if (cat.locked) {
      state.selectedCategories.add(cat.id);
      cat.features.forEach(f => {
        state.selectedFeatures[f.id] = { qty: f.qty || 1 };
      });
    }
  });
  renderCategories();
  goTo(0);
}

function copyToClipboard() {
  let text = `Personal Technology — Home Configuration Estimate\nptech.la\n\n`;
  text += `Client: ${state.client.first} ${state.client.last}\n`;
  text += `Address: ${state.client.address}\n`;
  text += `Square Footage: ${parseInt(state.client.sqft).toLocaleString()} sq ft\n`;
  text += `Date: ${new Date().toLocaleDateString()}\n\n`;

  const selected = CATEGORIES.filter(c => state.selectedCategories.has(c.id));
  let grand = 0;
  for (const cat of selected) {
    let sub = 0;
    let lines = [];
    for (const f of cat.features) {
      const isAlways = !!(f.alwaysSelected || cat.locked);
      const isSel = isAlways ? true : !!state.selectedFeatures[f.id];
      if (!isSel) continue;
      const qty = state.selectedFeatures[f.id]?.qty || f.qty || 1;
      const unitPrice = getFeaturePrice(f);
      const line = f.hasQty ? unitPrice * qty : unitPrice;
      sub += line;
      lines.push(`  ${f.name}${f.hasQty && !isAlways ? ` ×${qty}` : ''} ...... $${line.toLocaleString()}`);

      // Music sub-options
      if (f.id === 'mus1' && cat.musicSubOptions) {
        for (const group of cat.musicSubOptions) {
          for (const sf of group.items) {
            if (!state.selectedFeatures[sf.id]) continue;
            const sline = getMusicSubTotal(sf);
            if (sline === 0) continue;
            let qtyStr = '';
            if (sf.dualUpgrade) {
              const st = state.selectedFeatures[sf.id];
              const parts = [];
              if (st.q1 > 0) parts.push(`${st.q1}×1pair`);
              if (st.q2 > 0) parts.push(`${st.q2}×2pairs`);
              qtyStr = parts.join(', ');
            } else {
              qtyStr = `×${state.selectedFeatures[sf.id].qty || 1}`;
            }
            sub += sline;
            lines.push(`    ↳ ${sf.name} ${qtyStr} ...... $${sline.toLocaleString()}`);
          }
        }
      }
    }

    // Video sub-options — once per category after all features
    if (cat.videoSubOptions) {
      for (const sf of cat.videoSubOptions) {
        if (!state.selectedFeatures[sf.id]) continue;
        const sqty = state.selectedFeatures[sf.id].qty || 1;
        const sline = getVideoSubPrice(sf, sqty);
        const qtyStr = sf.tvPrice ? `${countSelectedTVs()} TVs` : `×${sqty}`;
        sub += sline;
        lines.push(`    ↳ ${sf.name} ${qtyStr} ...... $${sline.toLocaleString()}`);
      }
    }

    if (!lines.length) continue;
    text += `--- ${cat.name} ---\n` + lines.join('\n') + `\n  Subtotal: $${sub.toLocaleString()}`;
    if (state.notes[cat.id]) {
      text += `\n  Notes: ${state.notes[cat.id]}`;
    }
    text += '\n\n';
    grand += sub;
  }
  const taxAmount = Math.round(grand * 0.07);
  const grandWithTax = grand + taxAmount;
  text += `\nSales Tax (7%): $${taxAmount.toLocaleString()}`;
  text += `\nESTIMATED TOTAL: $${grandWithTax.toLocaleString()}\n\nEstimate only. Final pricing subject to site assessment and signed proposal.`;
  navigator.clipboard.writeText(text).then(() => showToast('Copied to clipboard!'));
}

function showToast(msg) {
  const t = document.getElementById('toast');
  t.textContent = msg;
  t.classList.add('show');
  setTimeout(() => t.classList.remove('show'), 3000);
}

// ─────────────────────────────────────────────────────────────
// NEXT STEPS
// ─────────────────────────────────────────────────────────────
const NS_CHECKED = { 1: false, 2: false, 3: false, 4: false };

function goToNextSteps() {
  // Grab the live grandWithTax from the grand-total display
  const totalText = document.getElementById('grand-total').textContent.replace(/[$,]/g, '');
  const total = parseInt(totalText) || 0;

  // Populate section 1 total
  document.getElementById('ns-total-display').textContent =
    '$' + total.toLocaleString();

  // Section 2: design fee = 3% rounded to nearest $10
  const designFee = Math.round(total * 0.03 / 10) * 10;
  document.getElementById('ns-design-fee').textContent =
    '$' + designFee.toLocaleString();

  // Section 3: payments all sum to Estimated Total
  // Design fee payment = designFee (already calculated above, 3% rounded to $10)
  // Remaining balance = total - designFee
  // The 4 milestone payments split the remaining balance
  const remaining = total - designFee;
  const pay1 = Math.round(remaining * 0.27 / 10) * 10;
  const pay2 = Math.round(remaining * 0.40 / 10) * 10;
  const pay3 = Math.round(remaining * 0.20 / 10) * 10;
  // Day 1 gets whatever is left so everything adds up exactly
  const pay4 = total - designFee - pay1 - pay2 - pay3;

  document.getElementById('ns-pay-design').textContent = '$' + designFee.toLocaleString();
  document.getElementById('ns-pay-1').textContent = '$' + pay1.toLocaleString();
  document.getElementById('ns-pay-2').textContent = '$' + pay2.toLocaleString();
  document.getElementById('ns-pay-3').textContent = '$' + pay3.toLocaleString();
  document.getElementById('ns-pay-4').textContent = '$' + pay4.toLocaleString();
  document.getElementById('ns-pay-total').textContent = '$' + total.toLocaleString();

  // Reset all checkboxes
  for (let i = 1; i <= 4; i++) {
    NS_CHECKED[i] = false;
    const box = document.getElementById('ns-box-' + i);
    if (box) box.classList.remove('checked');
    const lbl = document.getElementById('ns-clabel-' + i);
    const defaultLabels = ['Approve Estimate','Accept Design Contract','Acknowledge Payment Schedule','Ready to Proceed'];
    if (lbl) lbl.textContent = defaultLabels[i-1];
    const sec = document.getElementById('ns-' + i);
    if (sec) sec.classList.remove('done', 'active', 'locked', 'unlocking');
    const btn = document.getElementById('ns-cb-' + i);
    if (btn) { btn.disabled = i !== 1; }
  }
  document.getElementById('ns-1').classList.add('active');
  for (let i = 2; i <= 4; i++) document.getElementById('ns-' + i).classList.add('locked');

  const acceptBtn = document.getElementById('ns-accept-btn');
  acceptBtn.disabled = true;
  document.getElementById('ns-accept-note').textContent = 'Confirm all four sections above to enable submission.';

  // Navigate
  document.querySelectorAll('.step').forEach(el => el.classList.remove('active'));
  document.getElementById('step-next').classList.add('active');
  // Hide progress bar on this step (no matching progress index)
  document.getElementById('progress-fill').style.width = '100%';
  for (let i = 0; i < 4; i++) {
    const el = document.getElementById('pl-' + i);
    el.classList.remove('active', 'done');
    el.classList.add('done');
  }
  requestAnimationFrame(() => window.scrollTo({ top: 0, behavior: 'instant' }));
}

function nsCheck(n) {
  if (NS_CHECKED[n]) return; // already checked
  NS_CHECKED[n] = true;

  // Animate the checkbox
  const box = document.getElementById('ns-box-' + n);
  box.classList.add('checked');
  const lbl = document.getElementById('ns-clabel-' + n);
  lbl.textContent = 'Confirmed';
  const sec = document.getElementById('ns-' + n);
  sec.classList.remove('active');
  sec.classList.add('done');

  // Unlock next section
  const next = n + 1;
  if (next <= 4) {
    const nextSec = document.getElementById('ns-' + next);
    const nextBtn = document.getElementById('ns-cb-' + next);
    nextSec.classList.remove('locked');
    nextSec.classList.add('unlocking', 'active');
    nextBtn.disabled = false;
    // Scroll the newly unlocked section into view
    setTimeout(() => {
      nextSec.scrollIntoView({ behavior: 'smooth', block: 'center' });
    }, 200);
  }

  // Check if all four are done → enable Accept
  if (NS_CHECKED[1] && NS_CHECKED[2] && NS_CHECKED[3] && NS_CHECKED[4]) {
    const btn = document.getElementById('ns-accept-btn');
    btn.disabled = false;
    document.getElementById('ns-accept-note').textContent =
      'Submitting will email the proposal to the client and notify Personal Technology.';
    setTimeout(() => {
      btn.scrollIntoView({ behavior: 'smooth', block: 'center' });
    }, 300);
  }
}

function plClick(n) {
  // Allow navigation to any step up to the furthest step visited
  if (n <= state.maxStep) goTo(n);
}


function buildProposalText() {
  const clientEmail = (state.client.email || '').trim();
  const clientName  = ((state.client.first || '') + ' ' + (state.client.last || '')).trim();
  const date        = new Date().toLocaleDateString('en-US', { year:'numeric', month:'long', day:'numeric' });
  const div = '─────────────────────────────';

  let text = `PERSONAL TECHNOLOGY — HOME CONFIGURATION PROPOSAL\nptech.la\n`;
  text += `${div}\n\n`;
  text += `CLIENT\n`;
  text += `  Name:           ${clientName || '—'}\n`;
  text += `  Address:        ${state.client.address || '—'}\n`;
  text += `  Phone:          ${state.client.phone || '—'}\n`;
  text += `  Email:          ${clientEmail || '—'}\n`;
  text += `  Square Footage: ${parseInt(state.client.sqft || 2400).toLocaleString()} sq ft\n`;
  text += `  Date:           ${date}\n\n`;
  text += `${div}\n\n`;
  text += `SYSTEMS ESTIMATE\n\n`;

  const selected = CATEGORIES.filter(c => state.selectedCategories.has(c.id));
  let grand = 0;

  for (const cat of selected) {
    let sub = 0;
    const lines = [];

    for (const f of cat.features) {
      const isAlways = !!(f.alwaysSelected || cat.locked);
      const isSel = isAlways ? true : !!state.selectedFeatures[f.id];
      if (!isSel) continue;
      const qty = state.selectedFeatures[f.id]?.qty || f.qty || 1;
      const unitPrice = getFeaturePrice(f);
      const line = f.hasQty ? unitPrice * qty : unitPrice;
      sub += line;
      const qtyLabel = (f.hasQty && !isAlways && qty > 1) ? ` ×${qty}` : '';
      lines.push(`  ${f.name}${qtyLabel} ...... $${line.toLocaleString()}`);

      // Music sub-options
      if (f.id === 'mus1' && cat.musicSubOptions) {
        for (const group of cat.musicSubOptions) {
          for (const sf of group.items) {
            if (!state.selectedFeatures[sf.id]) continue;
            const sline = getMusicSubTotal(sf);
            if (sline === 0) continue;
            let qtyStr = '';
            if (sf.dualUpgrade) {
              const st = state.selectedFeatures[sf.id];
              const parts = [];
              if (st.q1 > 0) parts.push(`${st.q1}×1pair`);
              if (st.q2 > 0) parts.push(`${st.q2}×2pairs`);
              qtyStr = parts.length ? ' (' + parts.join(', ') + ')' : '';
            } else {
              qtyStr = ` ×${state.selectedFeatures[sf.id].qty || 1}`;
            }
            sub += sline;
            lines.push(`    ↳ ${sf.name}${qtyStr} ...... $${sline.toLocaleString()}`);
          }
        }
      }
    }

    // Video sub-options — once per category after all features
    if (cat.videoSubOptions) {
      for (const sf of cat.videoSubOptions) {
        if (!state.selectedFeatures[sf.id]) continue;
        const sqty = state.selectedFeatures[sf.id].qty || 1;
        const sline = getVideoSubPrice(sf, sqty);
        const qtyStr = sf.tvPrice ? ` (${countSelectedTVs()} TVs)` : ` ×${sqty}`;
        sub += sline;
        lines.push(`    ↳ ${sf.name}${qtyStr} ...... $${sline.toLocaleString()}`);
      }
    }

    if (!lines.length) continue;
    grand += sub;
    text += `[ ${cat.name.toUpperCase()} ]\n`;
    text += lines.join('\n') + '\n';
    text += `  ${'─'.repeat(32)}\n`;
    text += `  Subtotal: $${sub.toLocaleString()}\n`;
    if (state.notes[cat.id]) {
      text += `  Notes: ${state.notes[cat.id]}\n`;
    }
    text += '\n';
  }

  const salesTax = Math.round(grand * 0.07);
  const grandWithTax = grand + salesTax;
  const designFee = Math.round(grandWithTax * 0.03 / 10) * 10;
  const remaining = grandWithTax - designFee;
  const pay1 = Math.round(remaining * 0.27 / 10) * 10;
  const pay2 = Math.round(remaining * 0.40 / 10) * 10;
  const pay3 = Math.round(remaining * 0.20 / 10) * 10;
  const pay4 = grandWithTax - designFee - pay1 - pay2 - pay3;

  text += `${div}\n\n`;
  text += `FINANCIAL SUMMARY\n\n`;
  text += `  Systems Subtotal:        $${grand.toLocaleString()}\n`;
  text += `  Estimated Sales Tax (7%): $${salesTax.toLocaleString()}\n`;
  text += `  ESTIMATED TOTAL:         $${grandWithTax.toLocaleString()}\n`;
  text += `  Design & Engineering Fee: $${designFee.toLocaleString()}\n\n`;

  text += `${div}\n\n`;
  text += `SCHEDULE OF PAYMENTS\n\n`;
  text += `  Design Contract Fee (3%):       $${designFee.toLocaleString()}\n`;
  text += `  Proposal Acceptance (27%):      $${pay1.toLocaleString()}\n`;
  text += `  Completion of Rough-In (40%):   $${pay2.toLocaleString()}\n`;
  text += `  Scheduling of Trim (20%):       $${pay3.toLocaleString()}\n`;
  text += `  Day 1 (10%):                    $${pay4.toLocaleString()}\n`;
  text += `  ${'─'.repeat(38)}\n`;
  text += `  Estimated Total:                $${grandWithTax.toLocaleString()}\n\n`;

  text += `${div}\n\n`;
  text += `This proposal has been reviewed and accepted by the client.\n`;
  text += `Estimate only — final pricing subject to site assessment and signed proposal.\n\n`;
  text += `Personal Technology  ·  ptech.la`;

  return text;
}

async function nsAccept() {
  const btn  = document.getElementById('ns-accept-btn');
  const note = document.getElementById('ns-accept-note');
  btn.textContent = 'Sending…';
  btn.disabled = true;

  const clientEmail = (state.client.email || '').trim();
  const clientName  = ((state.client.first || '') + ' ' + (state.client.last || '')).trim();
  const date        = new Date().toLocaleDateString('en-US', { year:'numeric', month:'long', day:'numeric' });
  const subject     = `Personal Technology Proposal — ${clientName} — ${date}`;
  const messageBody = buildProposalText();

  try {
    if (!window.emailjs) {
      await new Promise((resolve, reject) => {
        const s = document.createElement('script');
        s.src = 'https://cdn.jsdelivr.net/npm/@emailjs/browser@4/dist/email.min.js';
        s.onload = resolve;
        s.onerror = () => reject(new Error('Failed to load EmailJS SDK'));
        document.head.appendChild(s);
      });
    }
    emailjs.init('Y2We8dm3ltBl_jGyt');

    await emailjs.send('service_obhrg8f', 'template_9mjotkb', {
      to_email: clientEmail || 'info@ptech.la',
      subject:  subject,
      message:  messageBody,
    });

    btn.textContent = '✓ Sent';
    btn.disabled = true;
    const sentTo = clientEmail ? `${clientEmail} and #pt-proposal_accepted` : '#pt-proposal_accepted';
    note.textContent = `Proposal sent to ${sentTo}.`;
    showToast('Proposal submitted successfully.');

  } catch (err) {
    console.error('EmailJS error:', err);
    btn.textContent = 'Accept';
    btn.disabled = false;
    const detail = err.text || err.message || err.status || JSON.stringify(err) || 'Unknown error';
    note.textContent = 'Send failed (' + detail + ')';
    note.style.color = 'var(--red)';
  }
}

init();
</script>
</body>
</html>
